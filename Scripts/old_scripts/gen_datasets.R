library(dplyr)
library(protr)
library(epitopes)

ncpus <- parallel::detectCores() - 1

hostIDs <- NULL 
# hostIDs <- 9606 

# orgID <- 6239 # Caenorhabditis elegans - Species
# orgID <- 6237 # Caenorhabditis - Genus
# orgID <- 55885 # Peloderinae - Subfamily
# orgID <- 6243 # Rhabditidae - Family
# orgID <- 2301119 # Rhabditomorpha - Infraorder 
# orgID <- 2301116 # Rhabditina - Suborder

# orgID <- 6236 # Rhabditida - Order
# orgID <- 119089 # Chromadorea - Class
# orgID <- 6231 # Nematoda - Phylum
# orgID <- 1206794 # Ecdysozoa - Clade
# orgID <- 33317 # Protostomia - Clade
# orgID <- 33213 # Bilateria - Clade
# orgID <- 6072 # Eumetazoa - Clade
# orgID <- 33208 # Metazoa - Kingdom
# orgID <- 33154 # Opisthokonta - Clade
# orgID <- 2759 # Eukaryota - Superkingdom
# orgID <- 131567 # Cellular Organisms - No Rank

savefile <- "./jan_data/elegans_data.rds"

epitopes <- readRDS("./data/epitopes.rds") # Generated by get_IEDB() followed by get_LBCE()
proteins <- readRDS("./data/proteins.rds") # Generated by get_proteins()
taxonomy <- readRDS("./data/taxonomy.rds") # Generated by get_taxonomy()

t0 <- Sys.time()

peptides.list <- epitopes %>%
  filter_epitopes(orgIDs        = orgID,
                  orgID_column  = "sourceOrg_id",
                  hostID_column = "host_id",
                  tax_list      = taxonomy) %>%
  consolidate_data(proteins, only_exact = FALSE, ncpus = ncpus) %>%
  extract_peptides(min_peptide = 8, max_epitope = 25) %>%
  make_data_splits(proteins    = proteins,
                   target_props = c(.25, .75), # <--- desired split ratios
                   similarity_threshold = .5,
                   #return_front = 21,
                   ncpus = ncpus) %>%
  calc_features(local.features = c("Entropy","MolWeight", "AAtypes", "Atoms",   # <--- local features are calculated for the 15-AA windows and added to peptides.list$df
                                   "AAC", "CTDC", "CTDD", "CTDT", "BLOSUM"),
                global.features = c("AAC", "DC", "CTDC", "CTDD",                # <--- global features are calculated at the full protein level and added to peptides.list$proteins (needs a data join on df later, before training the models)
                                    "CTDT", "CTriad", "SOCN",
                                    "Entropy", "MolWeight", "AAtypes"),
                ncpus = ncpus) %>%
  save_peptide_list("./jan_data/elegans")

saveRDS(peptides.list, savefile)

t1 <- Sys.time()
message("Elapsed time: ", signif(t1 - t0, 3), " ", units(t1 - t0))
