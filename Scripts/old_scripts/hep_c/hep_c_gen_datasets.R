# this script uses the devel-next version of the epitopes package:
# > install.packages("BiocManager")
# > BiocManager::install("Biostrings")
# > devtools::install_github("fcampelo/epitopes@devel-next", force = TRUE)

library(dplyr)
library(protr)
library(epitopes)

ncpus <- parallel::detectCores() - 1

# hostIDs <- 9606 # Human 
hostIDs <- NULL 
orgID <- 11103 # Hepacivirus C

orgID <- 11102 # Hepacivirus
orgID <- 11050 # Flaviviridae
orgID <- 2732545 # Amarillovirales
orgID <- 2732462 # Flasuviricetes
orgID <- 2732406 # Kitrinoviricota
orgID <- 2732396 # Orthornavirae 
orgID <- 2559587 # Riboviria
orgID <- 10239 # Viruses

savefile <- "./data/hep_c_data/hep_c.rds"

epitopes <- readRDS("./data/epitopes.rds") # Generated by get_IEDB() followed by get_LBCE()
proteins <- readRDS("./data/proteins.rds") # Generated by get_proteins()
taxonomy <- readRDS("./data/taxonomy.rds") # Generated by get_taxonomy()

# t0 <- Sys.time()

peptides.list <- epitopes %>%
  filter_epitopes(orgIDs        = orgID,
                  orgID_column  = "sourceOrg_id",
                  hostID_column = "host_id",
                  tax_list      = taxonomy) %>%
  consolidate_data(proteins, only_exact = FALSE, ncpus = ncpus) %>%
  extract_peptides(min_peptide = 8, max_epitope = 25) %>%
  make_data_splits(proteins    = proteins,
                   target_props = c(.25, .75), # <--- desired split ratios
                   similarity_threshold = .5,
                   #return_front = 21,
                   ncpus = ncpus) %>%
  calc_features(local.features = c("Entropy","MolWeight", "AAtypes", "Atoms",   # <--- local features are calculated for the 15-AA windows and added to peptides.list$df
                                   "AAC", "CTDC", "CTDD", "CTDT", "BLOSUM"),
                global.features = c("AAC", "DC"),
                ncpus = ncpus) %>%
  save_peptide_list("./data/hep_c_data/hep_c")

saveRDS(peptides.list, savefile)

# peptides.list will be a list with the full information on the resulting data,
# peptides.list$df       - windowed dataframe, incl. local features and data split information
# peptides.list$peptides - dataframe with information about the (non-windowed) peptides.
# peptides.list$proteins - dataframe of protein information, incl. global features.
# peptides.list$peptide.attrs  - attributes related to how the peptides were extracted
# peptides.list$peptide.attrs  - attributes related to how the data splits were defined
# peptides.list$feature.attrs  - attributes related to which features were calculated


# t1 <- Sys.time()
# message("Elapsed time: ", signif(t1 - t0, 3), " ", units(t1 - t0))
saveRD